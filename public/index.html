<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadro de Projetos Simplificado (GitHub Sync)</title>
    <!-- O CSS e a maior parte do HTML permanecem os mesmos -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cor-primaria: #0073ea; --cor-primaria-clara: #e6f1fc; --cor-fundo: #f7f8fa;
            --cor-borda: #e4e7eb; --cor-texto-principal: #1a1a1a; --cor-texto-secundario: #5e6c84;
            --cor-sombra: rgba(26, 26, 26, 0.07); --cor-branco: #ffffff; --cor-perigo: #e2445c;
            --raio-borda: 8px; --velocidade-transicao: 0.2s;
        }
        body.dark-mode {
            --cor-primaria: #0a84ff; --cor-primaria-clara: #1c3d5f; --cor-fundo: #1c1c1e;
            --cor-borda: #3a3a3c; --cor-texto-principal: #f2f2f7; --cor-texto-secundario: #8e8e93;
            --cor-sombra: rgba(0, 0, 0, 0.2); --cor-branco: #2c2c2e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto-principal); line-height: 1.5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--cor-borda); }
        header h1 { color: var(--cor-texto-principal); font-size: 24px; }
        header .acoes-globais { display: flex; gap: 10px; flex-wrap: wrap; }
        #btn-toggle-dark-mode { background: none; border: 1px solid var(--cor-borda); color: var(--cor-texto-secundario); padding: 8px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #btn-toggle-dark-mode:hover { background-color: var(--cor-fundo); border-color: #c1c7d0; }
        .btn { display: inline-flex; align-items: center; gap: 8px; background-color: var(--cor-primaria); color: var(--cor-branco); border: none; padding: 9px 15px; border-radius: var(--raio-borda); cursor: pointer; font-weight: 500; font-size: 14px; text-decoration: none; transition: all var(--velocidade-transicao) ease; }
        body:not(.dark-mode) .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 115, 234, 0.2); }
        .btn:disabled { background-color: var(--cor-texto-secundario); cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .btn-secundario { background-color: var(--cor-branco); color: var(--cor-texto-secundario); border: 1px solid var(--cor-borda); }
        .btn-secundario:hover { background-color: var(--cor-fundo); border-color: #c1c7d0; box-shadow: none; }
        .btn-acao, .btn-excluir { background: none; border: none; cursor: pointer; color: var(--cor-texto-secundario); padding: 4px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all var(--velocidade-transicao); }
        .btn-acao:hover, .btn-excluir:hover { background-color: #e9ecef; color: var(--cor-texto-principal); }
        .btn-excluir:hover { color: var(--cor-perigo); }
        .btn-acao svg, .btn-excluir svg { width: 17px; height: 17px; }
        .btn.btn-alteracao-pendente {
    background-color: #f7b928; /* Uma cor de "aviso", como amarelo/laranja */
    color: #1a1a1a;
    font-weight: 600; }
        .btn.btn-alteracao-pendente:hover {
    background-color: #f5b00f;
    box-shadow: 0 4px 10px rgba(247, 185, 40, 0.3); }
        .projeto { background-color: var(--cor-branco); border: 1px solid var(--cor-borda); border-radius: var(--raio-borda); margin-bottom: 25px; box-shadow: 0 2px 4px var(--cor-sombra); overflow: hidden; transition: all var(--velocidade-transicao) ease; }
        .projeto-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; border-bottom: 1px solid var(--cor-borda); cursor: pointer; }
        .projeto-header-main { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .projeto-toggle-icon { transition: transform var(--velocidade-transicao) ease; }
        .projeto-titulo-input { font-size: 19px; font-weight: 600; color: var(--cor-texto-principal); border: none; background: transparent; padding: 5px; width: 100%; border-radius: 4px; }
        .projeto-titulo-input:focus { outline: none; background-color: var(--cor-primaria-clara); }
        .projeto-header-acoes { display: flex; align-items: center; }
        .tarefas-container, .projeto-footer { transition: max-height 0.3s ease-out, padding 0.3s ease-out, opacity 0.2s ease-out; max-height: 1000vh; /* Um valor alto para garantir que tudo caiba */ opacity: 1; }
        .projeto.recolhido { border-bottom-color: transparent; }
        .projeto.recolhido .tarefas-container, .projeto.recolhido .projeto-footer { max-height: 0; padding-top: 0; padding-bottom: 0; opacity: 0; overflow: hidden; }
        .projeto.recolhido .projeto-toggle-icon { transform: rotate(-90deg); }
        .tarefas-container { padding: 18px; display: flex; flex-direction: column; gap: 15px; }
        .card-tarefa { background-color: var(--cor-fundo); border: 1px solid var(--cor-borda); border-radius: var(--raio-borda); border-left: 4px solid transparent; transition: border-color var(--velocidade-transicao); }
        .card-tarefa.prazo-vencido { border-left-color: var(--cor-perigo); }
        .card-tarefa.prazo-proximo { border-left-color: #f7b928; }
        .card-tarefa-header { display: flex; align-items: center; gap: 10px; padding: 12px; cursor: grab; }
        .card-tarefa-header input[type="text"] { flex-grow: 1; border: 1px solid transparent; background: transparent; font-size: 15px; font-weight: 500; padding: 6px; border-radius: 4px; }
        .card-tarefa-header input[type="text"]:focus { background-color: var(--cor-branco); border-color: var(--cor-primaria); }
        .card-tarefa-header .prazo-input { border: 1px solid var(--cor-borda); border-radius: 4px; padding: 5px 8px; font-size: 13px; color: var(--cor-texto-secundario); width: 135px; }
        .card-tarefa-header .btn-excluir { margin-left: 5px; }
        .subtarefas-lista { padding: 0 12px 12px; }
        .linha-subtarefa { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
        .linha-subtarefa input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--cor-primaria); }
        .linha-subtarefa input[type="text"] { flex-grow: 1; border: none; background: transparent; font-size: 14px; padding: 4px; border-radius: 3px; }
        .linha-subtarefa input[type="text"]:focus { background-color: var(--cor-branco); outline: 1px solid var(--cor-borda); }
        .linha-subtarefa.concluida input[type="text"] { text-decoration: line-through; color: var(--cor-texto-secundario); }
        .linha-subtarefa .btn-excluir { visibility: hidden; opacity: 0; transition: all var(--velocidade-transicao); }
        .linha-subtarefa:hover .btn-excluir { visibility: visible; opacity: 1; }
        .progress-bar-container { background-color: #e9ecef; border-radius: 4px; height: 8px; margin: 4px 12px 12px; overflow: hidden; }
        .progress-bar { background-color: var(--cor-primaria); height: 100%; width: 0%; transition: width var(--velocidade-transicao) ease; }
        .card-tarefa-footer { padding: 0 12px 12px; display: flex; gap: 15px; }
        .btn-adicionar-subtarefa, .btn-adicionar-tarefa { background: none; border: none; color: var(--cor-primaria); cursor: pointer; font-weight: 500; font-size: 13px; display: flex; align-items: center; gap: 6px; padding: 5px; border-radius: 4px; }
        .btn-adicionar-subtarefa:hover, .btn-adicionar-tarefa:hover { background-color: var(--cor-primaria-clara); }
        .projeto-footer { padding: 12px 18px; border-top: 1px solid var(--cor-borda); background-color: var(--cor-fundo); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity var(--velocidade-transicao) ease; }
        .modal-overlay.visivel { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--cor-branco); padding: 30px; border-radius: var(--raio-borda); width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transform: scale(0.95); transition: transform var(--velocidade-transicao) ease; }
        .modal-overlay.visivel .modal-content { transform: scale(1); }
        .modal-content h3 { margin-bottom: 20px; font-size: 20px; text-align: center; }
        .modal-content input { width: 100%; border: 1px solid var(--cor-borda); padding: 12px; border-radius: var(--raio-borda); font-size: 16px; margin-bottom: 20px; }
        .modal-acoes { display: flex; justify-content: flex-end; gap: 10px; }

        /* --- Estilos para Notificações (Toast) --- */
        #notificacao-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: var(--raio-borda);
            color: var(--cor-branco);
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.3s forwards, fadeOut 0.3s 4s forwards;
        }
        .toast.sucesso { background-color: #28a745; }
        .toast.erro { background-color: var(--cor-perigo); }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        /* Media queries podem ser ajustadas depois, se necessário */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Quadro de Projetos</h1>
            <div class="acoes-globais">
                <button id="btn-toggle-dark-mode" title="Alternar tema"></button>
                <button class="btn" id="btn-salvar-github"></button>
                <button class="btn" id="btn-novo-projeto"></button>
            </div>
        </header>
        <main id="quadro-container"></main>
    </div>
    <div id="modal-novo-projeto" class="modal-overlay"></div>
    <div id="notificacao-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Objeto GITHUB_CONFIG foi REMOVIDO daqui para segurança.
        // As configurações agora estão nas variáveis de ambiente da Netlify.

        const app = {
            data: { projetos: [] },
            sha: null,
            alteracoesNaoSalvas: false, // <-- NOSSA NOVA BANDEIRA!
            icons: {
                add: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg>`,
                addSubtask: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M228,80a12,12,0,0,1-12,12H160v28h56a12,12,0,0,1,0,24H160v28h56a12,12,0,0,1,0,24H148a12,12,0,0,1-12-12V92H40a12,12,0,0,1,0-24H136V40a12,12,0,0,1,24,0V68h56A12,12,0,0,1,228,80Z"></path></svg>`,
                trash: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,160H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg>`,
                close: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111l63.51-63.52a12,12,0,0,1,17,17L145,128Z"></path></svg>`,
                sun: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M128,84a44,44,0,1,0,44,44A44.05,44.05,0,0,0,128,84Zm0,72a28,28,0,1,1,28-28A28,28,0,0,1,128,156ZM232,128A104.11,104.11,0,0,1,128,232,104.11,104.11,0,0,1,24,128,104.11,104.11,0,0,1,128,24,104.11,104.11,0,0,1,232,128Zm-16,0a88,88,0,1,0-88,88A88.1,88.1,0,0,0,216,128Z"></path></svg>`,
                moon: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M216.7,152.55A95.78,95.78,0,0,1,128,224a96,96,0,0,1-95.31-71.18a12,12,0,0,1,15.87-15.87A71.82,71.82,0,0,0,128,152a72.08,72.08,0,0,0,47.45-16.55,12,12,0,0,1,16.9,17.1Z"></path></svg>`,
                save: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M216,92H164V40a12,12,0,0,0-12-12H104A12,12,0,0,0,92,40V92H40a12,12,0,0,0-12,12v96a12,12,0,0,0,12,12H216a12,12,0,0,0,12-12V104A12,12,0,0,0,216,92ZM108,44h40V92H108Zm104,152H44V108H212Z"></path></svg>`,
                calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H184V24a12,12,0,0,0-24,0v8H96V24a12,12,0,0,0-24,0v8H48A20,20,0,0,0,28,52V208a20,20,0,0,0,20,20H208a20,20,0,0,0,20-20V52A20,20,0,0,0,208,32Zm-4,172H52V88H204Zm0-144H52V56H72v8a12,12,0,0,0,24,0V56h64v8a12,12,0,0,0,24,0V56h20Z"></path></svg>`,
                spinner: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M232,128a104,104,0,0,1-208,0c0-41,23.81-78.36,60.66-95.27a12,12,0,0,1,8.68,22.54C67.43,69.15,44,96.63,44,128a84,84,0,0,0,168,0c0-31.37-23.43-58.85-51.34-72.73a12,12,0,0,1,8.68-22.54C208.19,49.64,232,87,232,128Z"><animateTransform attributeName="transform" type="rotate" from="0 128 128" to="360 128 128" dur="1s" repeatCount="indefinite"></animateTransform></path></svg>`,
                chevron: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M165.66,202.34a8,8,0,0,1-11.32,0L80,128,154.34,53.66a8,8,0,0,1,11.32,11.32L97,128l68.66,63.02A8,8,0,0,1,165.66,202.34Z" transform="rotate(270 128 128)"></path></svg>`
            },

            mostrarNotificacao(mensagem, tipo = 'sucesso') {
                const container = document.getElementById('notificacao-container');
                const toast = document.createElement('div');
                toast.className = `toast ${tipo}`;
                toast.textContent = mensagem;
                container.appendChild(toast);

                // Remove o toast após a animação de fadeOut terminar (4s + 0.3s)
                setTimeout(() => {
                    toast.remove();
                }, 4300);
            },

            marcarAlteracao() {
        this.alteracoesNaoSalvas = true;
        const btnSalvar = document.getElementById('btn-salvar-github');
        btnSalvar.classList.add('btn-alteracao-pendente'); // Adicionaremos este estilo
        btnSalvar.innerHTML = `${this.icons.save} Salvar Alterações*`;
    },
            
            async init() {
                this.setupDarkMode();
                this.preencherElementosIniciais();
                this.renderLoading();
                this.attachEventListeners();
                await this.carregarDoGitHub();
                this.render();
            },
            
            // --- FUNÇÕES DE SINCRONIZAÇÃO COM O PROXY ---
            async carregarDoGitHub() {
                const url = `/.netlify/functions/github-proxy`;
                try {
                    const response = await fetch(url, { method: 'GET' });
                    
                    if (response.status === 404) {
                        this.data = { projetos: [] };
                        this.sha = null;
                        console.log('Arquivo não encontrado no GitHub. Iniciando com quadro vazio.');
                        return;
                    }

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Resposta inválida do servidor.' }));
                        throw new Error(`Erro no Proxy ao carregar: ${errorData.error || response.statusText}`);
                    }
                    
                    const fileData = await response.json();
                    console.log('Dados carregados do GitHub:', fileData);
                    this.sha = fileData.sha;
                    console.log('SHA inicial definido como:', this.sha);
                    
                    const contentBase64 = fileData.content;
                    const decodedUtf8 = decodeURIComponent(escape(window.atob(contentBase64)));
                    
                    this.data = JSON.parse(decodedUtf8); 
this.alteracoesNaoSalvas = false; // <-- ADICIONAR AQUI
                } catch (error) {
                    this.renderError('Falha ao carregar dados. Verifique a configuração na Netlify e a conexão.<br><br><small>' + error.message + '</small>');
                    console.error('Erro detalhado ao carregar:', error);
                }
            },

            async salvarNoGitHub() {
                const btnSalvar = document.getElementById('btn-salvar-github');
                btnSalvar.disabled = true;
                btnSalvar.innerHTML = `${this.icons.spinner} Salvando...`;
                
                const jsonString = JSON.stringify(this.data, null, 2);
                const contentEncoded = window.btoa(unescape(encodeURIComponent(jsonString)));

                const url = `/.netlify/functions/github-proxy`;
                const body = {
                    message: `Atualização do quadro: ${new Date().toISOString()}`,
                    content: contentEncoded,
                    sha: this.sha
                };
                
                console.log('Enviando para o proxy:', body);

                try {
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json' // <-- A CORREÇÃO ESSENCIAL
                        },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Resposta inválida do servidor.' }));
                        throw new Error(`Erro no Proxy ao salvar: ${errorData.error || response.statusText}`);
                    }

                    const responseData = await response.json();
                    console.log('Resposta recebida do proxy:', responseData);

                    if (responseData && responseData.content && responseData.content.sha) {
                        this.sha = responseData.content.sha;
                        console.log('NOVO SHA definido como:', this.sha);
                        
                        this.alteracoesNaoSalvas = false;
                        const btnSalvar = document.getElementById('btn-salvar-github');
                        btnSalvar.classList.remove('btn-alteracao-pendente');
                        btnSalvar.innerHTML = `${this.icons.save} Salvar Alterações`;

                        this.mostrarNotificacao('Dados salvos no GitHub com sucesso!', 'sucesso');
                    } else {
                        throw new Error('Resposta do proxy não continha o novo SHA.');
                    }
                } catch (error) {
                    console.error('Erro detalhado ao salvar:', error);
                    this.mostrarNotificacao(`Falha ao salvar no GitHub. ${error.message}`, 'erro');
                } finally {
                    btnSalvar.disabled = false;
                    btnSalvar.innerHTML = `${this.icons.save} Salvar Alterações`;
                }
            },

            // --- O restante do código permanece o mesmo ---
            preencherElementosIniciais() {
                document.getElementById('btn-salvar-github').innerHTML = `${this.icons.save} Salvar Alterações`;
                document.getElementById('btn-novo-projeto').innerHTML = `${this.icons.add} Novo Projeto`;
                document.getElementById('modal-novo-projeto').innerHTML = `<div class="modal-content"><h3>Adicionar Novo Projeto</h3><input type="text" id="input-nome-projeto" placeholder="Digite o nome do projeto..." autocomplete="off"><div class="modal-acoes"><button id="btn-modal-cancelar" class="btn btn-secundario">Cancelar</button><button id="btn-modal-salvar" class="btn">Salvar</button></div></div>`;
            },
            renderLoading() { document.getElementById('quadro-container').innerHTML = `<p style="text-align:center; padding: 40px;">Carregando dados do GitHub...</p>`; },
            renderError(mensagem) { document.getElementById('quadro-container').innerHTML = `<p style="text-align:center; color: var(--cor-perigo); padding: 40px; background: var(--cor-branco); border-radius: var(--raio-borda); border: 1px dashed var(--cor-perigo);">${mensagem}</p>`; },
            alertaInicial() {
                document.getElementById('quadro-container').innerHTML = `<p style="text-align:center; color: var(--cor-texto-secundario); padding: 40px 20px; background: var(--cor-branco); border-radius: var(--raio-borda); border: 1px dashed var(--cor-borda);">Nenhum projeto por aqui. Que tal <a href="#" id="link-criar-primeiro">criar o primeiro</a>?</p>`;
                document.getElementById('link-criar-primeiro')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Link "criar o primeiro" clicado!');
                    this.toggleModal(true);
                });
            },
            toggleModal(show) {
                console.log(`Chamando toggleModal com: ${show}`);
                const modal = document.getElementById('modal-novo-projeto');
                const input = document.getElementById('input-nome-projeto');
                if (show) { modal.classList.add('visivel'); input.focus(); } else { modal.classList.remove('visivel'); input.value = ''; }
            },
            generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); },
            render() {
                const container = document.getElementById('quadro-container');
                container.innerHTML = '';
                if (this.data.projetos.length === 0) { this.alertaInicial(); return; }
                this.data.projetos.forEach(projeto => {
                    const projetoEl = document.createElement('div');
                    // A classe 'recolhido' será gerenciada dinamicamente
                    projetoEl.className = 'projeto';
                    projetoEl.dataset.projetoId = projeto.id;
                    
                    const tarefasContainer = document.createElement('div');
                    tarefasContainer.className = 'tarefas-container';
                    projeto.tarefas.forEach(tarefa => {
                        const tarefaEl = this.getTarefaElement(projeto.id, tarefa);
                        tarefasContainer.appendChild(tarefaEl);
                    });

                    projetoEl.innerHTML = `
                        <div class="projeto-header" data-action="toggle-projeto">
                            <div class="projeto-header-main">
                                <span class="projeto-toggle-icon">${this.icons.chevron}</span>
                                <input type="text" value="${projeto.nome}" data-field="nome-projeto" class="projeto-titulo-input" title="Editar nome do projeto">
                            </div>
                            <div class="projeto-header-acoes">
                                <button class="btn-excluir" data-action="excluir-projeto" title="Excluir Projeto">${this.icons.trash}</button>
                            </div>
                        </div>`;
                    
                    projetoEl.appendChild(tarefasContainer);
                    
                    const footer = document.createElement('div');
                    footer.className = 'projeto-footer';
                    footer.innerHTML = `<button class="btn-adicionar-tarefa" data-action="adicionar-tarefa">${this.icons.add} Tarefa</button>`;
                    projetoEl.appendChild(footer);

                    container.appendChild(projetoEl);
                });
                this.initSortable();
            },

            getTarefaElement(projetoId, tarefa) {
                const tarefaEl = document.createElement('div');
                tarefaEl.className = 'card-tarefa';

                if (tarefa.prazo) {
                    const hoje = new Date();
                    const prazo = new Date(tarefa.prazo + 'T23:59:59'); // Considerar o fim do dia
                    hoje.setHours(0, 0, 0, 0); // Normalizar para o início do dia

                    const diffTime = prazo.getTime() - hoje.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        tarefaEl.classList.add('prazo-vencido');
                    } else if (diffDays <= 2) { // Hoje, amanhã ou depois de amanhã
                        tarefaEl.classList.add('prazo-proximo');
                    }
                }

                tarefaEl.dataset.tarefaId = tarefa.id;
                tarefaEl.dataset.projetoId = projetoId;

                const subtarefasHTML = tarefa.subtarefas.map(st => this.getSubtarefaHTML(tarefa.id, st)).join('');

                const totalSubtarefas = tarefa.subtarefas.length;
                let progressoHTML = '';
                if (totalSubtarefas > 0) {
                    const concluidas = tarefa.subtarefas.filter(st => st.concluida).length;
                    const progresso = (concluidas / totalSubtarefas) * 100;
                    progressoHTML = `
                        <div class="progress-bar-container" title="${concluidas} de ${totalSubtarefas} concluídas">
                            <div class="progress-bar" style="width: ${progresso}%;"></div>
                        </div>
                    `;
                }

                tarefaEl.innerHTML = `
                    <div class="card-tarefa-header">
                        <input type="text" value="${tarefa.nome}" data-field="nome" placeholder="Nome da tarefa..." class="nome-tarefa-input">
                        <input type="date" class="prazo-input" value="${tarefa.prazo || ''}" data-field="prazo" title="Definir prazo">
                        <button class="btn-excluir" data-action="excluir-tarefa" title="Excluir Tarefa">${this.icons.trash}</button>
                    </div>
                    <div class="subtarefas-lista">
                        ${subtarefasHTML}
                    </div>
                    ${progressoHTML}
                    <div class="card-tarefa-footer">
                        <button class="btn-adicionar-subtarefa" data-action="adicionar-subtarefa">${this.icons.addSubtask} sub-tarefa</button>
                    </div>
                `;
                return tarefaEl;
            },

            getSubtarefaHTML(tarefaId, subtarefa) {
                const concluidaClass = subtarefa.concluida ? 'concluida' : '';
                return `
                    <div class="linha-subtarefa ${concluidaClass}" data-tarefa-id="${tarefaId}" data-subtarefa-id="${subtarefa.id}">
                        <input type="checkbox" data-action="toggle-subtarefa" title="Marcar como concluída" ${subtarefa.concluida ? 'checked' : ''}>
                        <input type="text" value="${subtarefa.nome}" data-field="nome-subtarefa" placeholder="Descreva a sub-tarefa...">
                        <button class="btn-excluir" data-action="excluir-subtarefa" title="Excluir Sub-tarefa">${this.icons.close}</button>
                    </div>`;
            },
            attachEventListeners() {
                console.log('Anexando event listeners...');
                document.getElementById('btn-salvar-github').addEventListener('click', () => this.salvarNoGitHub());
                document.getElementById('btn-novo-projeto').addEventListener('click', () => {
                    console.log('Botão "Novo Projeto" clicado!');
                    this.toggleModal(true);
                });
                document.getElementById('btn-modal-cancelar').addEventListener('click', () => this.toggleModal(false));
                document.getElementById('modal-novo-projeto').addEventListener('click', (e) => { if (e.target.id === 'modal-novo-projeto') this.toggleModal(false); });
                document.getElementById('btn-modal-salvar').addEventListener('click', () => { const input = document.getElementById('input-nome-projeto'); if (input.value.trim()) { this.adicionarProjeto(input.value.trim()); this.toggleModal(false); } });
                document.getElementById('quadro-container').addEventListener('click', e => {
                    const target = e.target.closest('[data-action]'); if (!target) return;
                    const action = target.dataset.action; 
                    const projetoEl = target.closest('.projeto');
                    const tarefaEl = target.closest('.card-tarefa');
                    const subtarefaEl = target.closest('.linha-subtarefa');

                    const projetoId = projetoEl?.dataset.projetoId;
                    const tarefaId = tarefaEl?.dataset.tarefaId;
                    const subtarefaId = subtarefaEl?.dataset.subtarefaId;

                    switch (action) {
                        case 'toggle-projeto':
                            // Impede que o toggle ocorra ao clicar no input ou no botão de excluir
                            if (e.target.closest('input, .btn-excluir')) return;
                            projetoEl.classList.toggle('recolhido');
                            break;
                        case 'excluir-projeto': if (confirm('Tem certeza que deseja excluir este projeto e todas as suas tarefas?')) { this.excluirProjeto(projetoId); } break;
                        case 'adicionar-tarefa': this.adicionarTarefa(projetoId); break;
                        case 'excluir-tarefa': if (confirm('Tem certeza que deseja excluir esta tarefa?')) { this.excluirTarefa(projetoId, tarefaId); } break;
                        case 'adicionar-subtarefa': this.adicionarSubtarefa(projetoId, tarefaId); break;
                        case 'excluir-subtarefa': this.excluirSubtarefa(projetoId, tarefaId, subtarefaId); break;
                        case 'toggle-subtarefa': 
                            this.toggleSubtarefa(projetoId, tarefaId, subtarefaId, target.checked); 
                            subtarefaEl.classList.toggle('concluida', target.checked); 
                            
                            // Atualiza a barra de progresso dinamicamente
                            const tarefa = this.findTarefa(projetoId, tarefaId);
                            if (tarefa && tarefa.subtarefas.length > 0) {
                                const total = tarefa.subtarefas.length;
                                const concluidas = tarefa.subtarefas.filter(st => st.concluida).length;
                                const progresso = (concluidas / total) * 100;
                                const progressBarContainer = tarefaEl.querySelector('.progress-bar-container');
                                if (progressBarContainer) {
                                    progressBarContainer.querySelector('.progress-bar').style.width = `${progresso}%`;
                                    progressBarContainer.title = `${concluidas} de ${total} concluídas`;
                                }
                            }
                            break;
                    }
                });
                document.getElementById('quadro-container').addEventListener('change', e => {
                    const field = e.target.dataset.field; if (!field) return;
                    const projetoId = e.target.closest('.projeto')?.dataset.projetoId;
                    const tarefaId = e.target.closest('.card-tarefa')?.dataset.tarefaId;
                    const subtarefaId = e.target.closest('.linha-subtarefa')?.dataset.subtarefaId;

                    if (field === "nome-projeto") this.atualizarProjeto(projetoId, 'nome', e.target.value);
                    else if (field === 'nome-subtarefa') this.atualizarSubtarefa(projetoId, tarefaId, subtarefaId, 'nome', e.target.value);
                    else this.atualizarTarefa(projetoId, tarefaId, field, e.target.value);
                });

window.addEventListener('beforeunload', (e) => {
        if (this.alteracoesNaoSalvas) {
            // Padrão exigido pelos navegadores modernos
            e.preventDefault();
            e.returnValue = '';
        }
    });
},

            adicionarProjeto(nome) { this.data.projetos.push({ id: this.generateId(), nome: nome, tarefas: [] }); this.render(); this.marcarAlteracao(); },
            excluirProjeto(id) { this.data.projetos = this.data.projetos.filter(p => p.id !== id); this.render(); this.marcarAlteracao(); },
            atualizarProjeto(id, campo, valor) { const p = this.data.projetos.find(p => p.id === id); if (p) p[campo] = valor; this.marcarAlteracao(); },
            adicionarTarefa(pId) { const p = this.data.projetos.find(p => p.id === pId); if (p) { p.tarefas.push({ id: this.generateId(), nome: 'Nova Tarefa', prazo: '', subtarefas: [] }); this.render(); this.marcarAlteracao(); } },
            excluirTarefa(pId, tId) { const p = this.data.projetos.find(p => p.id === pId); if (p) { p.tarefas = p.tarefas.filter(t => t.id !== tId); this.render(); this.marcarAlteracao(); } },
            atualizarTarefa(pId, tId, campo, valor) { const t = this.findTarefa(pId, tId); if (t) { t[campo] = valor; this.marcarAlteracao(); } },
            adicionarSubtarefa(pId, tId) { const t = this.findTarefa(pId, tId); if (t) { t.subtarefas.push({ id: this.generateId(), nome: '', concluida: false }); this.render(); this.marcarAlteracao(); } },
            excluirSubtarefa(pId, tId, stId) { const t = this.findTarefa(pId, tId); if (t) { t.subtarefas = t.subtarefas.filter(st => st.id !== stId); this.render(); this.marcarAlteracao(); } },
            toggleSubtarefa(pId, tId, stId, concluida) { const st = this.findSubtarefa(pId, tId, stId); if (st) st.concluida = concluida; this.marcarAlteracao(); },
            atualizarSubtarefa(pId, tId, stId, campo, valor) { const st = this.findSubtarefa(pId, tId, stId); if (st) st[campo] = valor; this.marcarAlteracao(); },
            findTarefa(pId, tId) { const p = this.data.projetos.find(p => p.id === pId); return p ? p.tarefas.find(t => t.id === tId) : null; },
            findSubtarefa(pId, tId, stId) { const t = this.findTarefa(pId, tId); return t ? t.subtarefas.find(st => st.id === stId) : null; },

            setupDarkMode() {
                const btn = document.getElementById('btn-toggle-dark-mode');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const savedTheme = localStorage.getItem('theme');

                const setTheme = (isDark) => {
                    if (isDark) {
                        document.body.classList.add('dark-mode');
                        btn.innerHTML = this.icons.sun;
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-mode');
                        btn.innerHTML = this.icons.moon;
                        localStorage.setItem('theme', 'light');
                    }
                };

                btn.addEventListener('click', () => {
                    setTheme(!document.body.classList.contains('dark-mode'));
                });

                // Define o tema inicial
                if (savedTheme) {
                    setTheme(savedTheme === 'dark');
                } else {
                    setTheme(prefersDark);
                }
            },
            
            initSortable() {
                if (!window.Sortable) {
                    console.error('SortableJS não foi carregado.');
                    return;
                }

                const quadroContainer = document.getElementById('quadro-container');
                
                // 1. Tornar os PROJETOS arrastáveis
                new Sortable(quadroContainer, {
                    animation: 150,
                    handle: '.projeto-header-main', // Usar o novo container do título como handle
                    onEnd: (evt) => {
                        const [movedItem] = this.data.projetos.splice(evt.oldIndex, 1);
                        this.data.projetos.splice(evt.newIndex, 0, movedItem);
                        this.marcarAlteracao();
                    }
                });

                // 2. Tornar as TAREFAS arrastáveis
                document.querySelectorAll('.tarefas-container').forEach(container => {
                    new Sortable(container, {
                        group: 'tarefas',
                        animation: 150,
                        handle: '.card-tarefa-header',
                        onEnd: (evt) => {
                            const { item, from, to, oldIndex, newIndex } = evt;
                            const oldProjetoId = from.closest('.projeto').dataset.projetoId;
                            const newProjetoId = to.closest('.projeto').dataset.projetoId;
                            const tarefaId = item.dataset.tarefaId;

                            const oldProjeto = this.data.projetos.find(p => p.id === oldProjetoId);
                            const tarefaIndex = oldProjeto.tarefas.findIndex(t => t.id === tarefaId);
                            const [tarefa] = oldProjeto.tarefas.splice(tarefaIndex, 1);

                            const newProjeto = this.data.projetos.find(p => p.id === newProjetoId);
                            newProjeto.tarefas.splice(newIndex, 0, tarefa);
                            
                            this.marcarAlteracao();
                            
                            // Se a tarefa mudou de projeto, é mais seguro re-renderizar tudo
                            if (oldProjetoId !== newProjetoId) {
                                this.render();
                            }
                        }
                    });
                });
            }
        };
        app.init();
    });
    </script>
</body>
</html>
